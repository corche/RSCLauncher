name: Build & Release (manual)

on:
    workflow_dispatch:
        inputs:
            tag:
                description: "릴리즈 태그 입력(예: v1.2.3)"
                required: true
                default: "v0.0.0"
            prerelease:
                description: "Mark as prerelease"
                required: false
                type: boolean
                default: false

permissions:
    contents: write

jobs:
    build:
        name: Build (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [macos-latest, ubuntu-latest, windows-latest]

        steps:
            - name: Check out Git repository
              uses: actions/checkout@v4

            - name: Set up Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.x"

            - name: Install Dependencies
              run: npm ci

            - name: Build (electron-builder)
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: npm run dist

            # dist 산출물(특히 latest*.yml / blockmap) 확인용 로그
            - name: List dist output (debug)
              shell: bash
              run: |
                  echo "===== dist tree ====="
                  if [ -d "dist" ]; then
                    ls -la dist
                    echo ""
                    echo "----- yml files -----"
                    find dist -maxdepth 2 -type f \( -name "*.yml" -o -name "*.yaml" \) -print
                    echo ""
                    echo "----- blockmap files -----"
                    find dist -maxdepth 2 -type f -name "*.blockmap" -print
                  else
                    echo "dist directory not found."
                    exit 1
                  fi

            - name: Upload dist artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: dist-${{ matrix.os }}
                  path: dist/**
                  if-no-files-found: error

    release:
        name: Create GitHub Release
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            # 릴리즈 직전, 다운로드된 아티팩트 구조/파일 확인
            - name: List downloaded artifacts (debug)
              shell: bash
              run: |
                  echo "===== artifacts tree ====="
                  ls -la artifacts || true
                  echo ""
                  echo "----- yml files -----"
                  find artifacts -type f \( -name "*.yml" -o -name "*.yaml" \) -print || true
                  echo ""
                  echo "----- blockmap files -----"
                  find artifacts -type f -name "*.blockmap" -print || true

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ inputs.tag }}
                  name: ${{ inputs.tag }}
                  prerelease: ${{ inputs.prerelease }}
                  generate_release_notes: true
                  files: |
                      # ---- installers (설치 파일만) ----
                      artifacts/**/RSC-Launcher-setup-*.exe
                      artifacts/**/RSC-Launcher-setup-*.msi
                      artifacts/**/RSC-Launcher-setup-*.dmg
                      artifacts/**/RSC-Launcher-setup-*.pkg
                      artifacts/**/RSC-Launcher-setup-*.zip
                      artifacts/**/RSC-Launcher-setup-*.AppImage

                      # ---- electron-updater metadata (필수) ----
                      artifacts/**/latest.yml
                      artifacts/**/latest-mac.yml
                      artifacts/**/latest-linux.yml

                      # ---- differential update (권장/사실상 필요) ----
                      artifacts/**/*.blockmap
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
